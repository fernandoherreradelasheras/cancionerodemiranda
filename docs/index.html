<!doctype html>
<html>
<head>
  <link rel="stylesheet" href="styles.css">
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>
</head>
<body>
  

<div class="panel-body" style="height: 100vh">
		<div id="selector" style="padding-bottom: 16px;">
			<label for="tonos">Selecciona un tono:</label>
			<select name="tonos" id="tonos">
			</select>
			<button id="generate-pdf">Download PDF</button>
		</div>
    <div id="app" class="panel" style="border: 1px solid lightgray; min-height: 90%; height: 90%">
		</div>
		<div id="foot" style="padding-top: 16px;">
Visor de las partituras del <a href="https://github.com/fernandoherreradelasheras/cancionerodemiranda/">repositorio del Cancionero de Miranda</a>
		
</div>

<script type="module">
    import 'https://editor.verovio.org/javascript/app/verovio-app.js';
		import { PDFWorkerProxy, VerovioWorkerProxy, ValidatorWorkerProxy } from 'https://editor.verovio.org/dist/worker-proxy.js'
		import { PDFGenerator } from 'https://editor.verovio.org/dist/pdf-generator.js'

    const repoRoot = "https://raw.githubusercontent.com/fernandoherreradelasheras/cancionerodemiranda/main/";

		const options = {
    	defaultView: 'responsive',
	    responsiveZoom: 3,
			enableDocument: true,
		}

    const tonos = [
      { "definition": "tonos/01_-_Un_imposible_me_mata/def.json" },
      { "definition": "tonos/02_-_Querido_imposible_mio/def.json" },
      { "definition": "tonos/03_-_Amariles_yo_no_puedo/def.json" },
      { "definition": "tonos/04_-_Mas_merece_quien_mas_ama/def.json" },
      { "definition": "tonos/05_-_En_carroza_de_cristal/def.json" },
      { "definition": "tonos/06_-_Ojos,_yo_no_di_licencia/def.json" },
    ];

		function loadTono(index, tono) {
      const dir = tono["definition"].substring(0, tono["definition"].lastIndexOf("/"));
			const fileUrl = repoRoot + dir + "/" + tono["data"]["mei_file"];
    	fetch(fileUrl)
				.then(function(response) {
            return response.text();
        })
        .then(function(text) {
            app.loadData(text);
            updateCurrentTono(index, tono);
        });
		}

		function updateCurrentTono(index, tono) {
      currentTono = index;
    }

		async function getTonoDefinitions(tonos) {
      for (let i = 0; i < tonos.length; i++) {
        const definitionPath = tonos[i]["definition"];
        const data = await getTonoDefinition(definitionPath);
        tonos[i]["data"] = data;
        appendTono(i, data);
        if (i == 0) {
          loadTono(0, tonos[0]);
        }
      }
    }

    async function getTonoDefinition(path) {
			const fileUrl = repoRoot + path;
    	return fetch(fileUrl)
				.then(function(response) {
            return response.json();
        })
        .then(function(json) {
            return json
        });
    }

    function appendTono(index, tono) {
      const select = document.getElementById("tonos"); 
      const option = document.createElement("option");
      const text = document.createTextNode(tono["title"]);
      option.setAttribute("value", index);
      option.appendChild(text)
      select.appendChild(option)
		}

		async function generatePdf() {
        if (!app.pdf) {
            const pdfWorkerURL = app.getWorkerURL("https://editor.verovio.org/dist/pdf-worker.js");
            const pdfWorker = new Worker(pdfWorkerURL);
            app.pdf = new PDFWorkerProxy(pdfWorker);
        }

        const pdfGenerator = new PDFGenerator(app.verovio, app.pdf, app.verovioOptions.scale);
        const pdfOutputStr = await pdfGenerator.generateFile();

        app.endLoading();

    		const aElement = document.createElement('a');

      	aElement.setAttribute('download', tonos[currentTono]["title"].replace(/\.[^\.]*$/, '.pdf'));
      	aElement.href = pdfOutputStr;
      	aElement.click();
    }


		var currentTono = 0;

		window.localStorage.removeItem("options");
    const app = new Verovio.App(document.getElementById("app"), options);

    localStorage.removeItem("options");

    document.getElementById("tonos").addEventListener("change", (event) => loadTono(event.target.value, tonos[event.target.value]));
    document.getElementById("generate-pdf").addEventListener("click", () => generatePdf());

    getTonoDefinitions(tonos);
</script>
 

</body>
</html>
